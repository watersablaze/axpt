generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ✅ User Accounts & Authentication
model Account {
  id String @id @default(auto()) @map("_id") @db.ObjectId
}

model Session {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String @unique
}

// ✅ Transaction Type Enum
enum TransactionTypeEnum {
  DEPOSIT
  WITHDRAWAL
  TRANSFER
}

// ✅ Transactions Model
model Transaction {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  senderId    String   @db.ObjectId @map("senderId") // ✅ Explicit mapping
  recipientId String   @db.ObjectId @map("recipientId") // ✅ Explicit mapping
  amount      Float 
  type        TransactionTypeEnum 
  status      String   @default("pending")
  createdAt   DateTime @default(now()) @map("createdAt") @db.Date 

  // ✅ Correctly Define Relationships
  sender    User @relation(name: "SentTransactions", fields: [senderId], references: [id])
  recipient User @relation(name: "ReceivedTransactions", fields: [recipientId], references: [id])

  // ✅ Indexes for Query Optimization
  @@index([senderId])
  @@index([recipientId])
  @@index([createdAt]) 
}

// ✅ Users Model
model User {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt           DateTime @default(now()) @map("createdAt") @db.Date
  updatedAt           DateTime @updatedAt @map("updatedAt") @db.Date
  email               String   @unique
  encryptedPrivateKey String
  industry            String?
  interests           String?
  isAdmin             Boolean  @default(false)
  iv                  String
  name                String
  password            String
  role                String   @default("user")
  walletAddress       String?  @unique
  walletBalance       Float    @default(0)
  avatar              String?

  // ✅ Connect transactions to users
  sentTransactions     Transaction[] @relation(name: "SentTransactions")
  receivedTransactions Transaction[] @relation(name: "ReceivedTransactions")
}

// ✅ Email Verification
model VerificationToken {
  id         String @id @default(auto()) @map("_id") @db.ObjectId
  identifier String @unique
  token      String @unique

  @@unique([identifier, token])
}

// ✅ JWT Revocation for Security
model RevokedToken {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  jti       String   @unique // ✅ Only keep unique constraint
  expiresAt DateTime // Expiration timestamp

  // ✅ Speed up token expiration cleanup
  @@index([expiresAt])
}